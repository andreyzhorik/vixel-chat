<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vixel Chat</title>
<style>
:root{
  --bg:#000;
  --panel:#1a0000;
  --accent1:#3D0000;
  --accent2:#950101;
  --accent3:#FF0000;
  --text:#fff;
  --input-bg:#111;
  --shadow:#FF0000;
}

*{box-sizing:border-box;margin:0;padding:0;font-family:sans-serif;}

body{
  background:var(--bg);
  color:var(--text);
}

#logo{
  display:block;
  margin:10px auto;
  width:150px;
  filter: drop-shadow(0 0 5px var(--accent3));
}

#chat-container{
  display:flex;
  flex-direction:column;
  height:90vh;
  width:420px;
  margin:0 auto;
  background:var(--panel);
  border:3px solid var(--accent3);
  border-radius:15px;
  overflow:hidden;
  box-shadow:0 0 15px var(--shadow);
}

#messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column-reverse;
  border-bottom:2px solid var(--accent3);
}

.message{
  margin:4px 0;
  padding:6px 8px;
  border-radius:8px;
  background:rgba(255,0,0,0.15);
  animation:fadeIn 0.3s ease;
}

@keyframes fadeIn{
  0%{opacity:0;transform:translateY(10px);}
  100%{opacity:1;transform:translateY(0);}
}

.message .username{
  font-weight:bold;
  margin-right:5px;
  text-shadow:0 0 3px var(--accent3);
}

.message .text{
  white-space:pre-wrap;
  word-wrap:break-word;
  text-shadow:0 0 2px var(--accent3);
}

#input-container{
  display:flex;
  padding:5px;
  background:var(--panel);
  border-top:3px solid var(--accent3);
}

#msg{
  flex:1;
  padding:6px;
  border-radius:8px;
  border:none;
  background:var(--input-bg);
  color:#fff;
  resize:none;
  box-shadow:0 0 5px var(--accent3) inset;
}

#msg:focus{outline:none;}

#send{
  padding:6px 12px;
  margin-left:5px;
  background:var(--accent3);
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
  box-shadow:0 0 5px var(--accent3);
  transition:0.2s;
}

#send:hover{
  background:var(--accent2);
  box-shadow:0 0 10px var(--accent3);
}

#users{
  background:#150000;
  color:#fff;
  padding:5px;
  overflow-y:auto;
  max-height:120px;
  border-bottom:2px solid var(--accent3);
}

.user{
  margin:3px 0;
  font-weight:bold;
  text-shadow:0 0 2px var(--accent3);
}

.color-btn{
  width:22px;
  height:22px;
  display:inline-block;
  margin-right:3px;
  cursor:pointer;
  border:2px solid #fff;
  border-radius:4px;
  box-shadow:0 0 5px var(--accent3);
}

#moreName,#moreAvatar{
  cursor:pointer;
  margin-left:5px;
  color:var(--accent3);
  font-weight:bold;
  text-decoration:underline;
}

#settings{
  padding:10px;
  color:#fff;
  border-top:2px solid var(--accent3);
  width:420px;
  margin:0 auto;
  border-radius:0 0 15px 15px;
  box-shadow:0 0 15px var(--shadow);
}

#settings span{margin-right:5px;}
</style>
</head>
<body>

<img id="logo" src="https://raw.githubusercontent.com/andreyzhorik/VIXEL/main/logonobg.png" alt="Vixel Logo">

<div id="chat-container">
  <div id="messages"></div>
  <div id="users"></div>
  <div id="input-container">
    <textarea id="msg" rows="1" placeholder="Type a message..."></textarea>
    <button id="send">Send</button>
  </div>
</div>

<div id="settings">
  <div>
    Name color: 
    <span class="color-btn" style="background:red" data-type="name" data-color="#FF0000"></span>
    <span class="color-btn" style="background:yellow" data-type="name" data-color="#FFFF00"></span>
    <span class="color-btn" style="background:green" data-type="name" data-color="#00FF00"></span>
    <span class="color-btn" style="background:blue" data-type="name" data-color="#00FFFF"></span>
    <span id="moreName">More</span>
  </div>
  <div style="margin-top:5px;">
    Avatar color:
    <span class="color-btn" style="background:red" data-type="avatar" data-color="#FF0000"></span>
    <span class="color-btn" style="background:yellow" data-type="avatar" data-color="#FFFF00"></span>
    <span class="color-btn" style="background:green" data-type="avatar" data-color="#00FF00"></span>
    <span class="color-btn" style="background:blue" data-type="avatar" data-color="#00FFFF"></span>
    <span id="moreAvatar">More</span>
  </div>
</div>

<script>
const API_URL = "https://ehciyxvbasqiiiurjuwu.supabase.co/rest/v1";
const API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoY2l5eHZiYXNxaWlpdXJqdXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzQzNTgsImV4cCI6MjA3OTY1MDM1OH0.yMZ8EqtPXJumjn2xHTXwG3jbWTNdDxrklYIkdXNcbQk";
const USERNAME = prompt("Enter username:").slice(0,20);
let nameColor = "#FF0000";
let avatarColor = "#FF0000";
let lastNameChange = 0;
const badWords = ["badword1","badword2"];

const messagesEl = document.getElementById("messages");
const usersEl = document.getElementById("users");
const msgInput = document.getElementById("msg");

function sanitize(text){
  badWords.forEach(w => text = text.replace(new RegExp(w,"gi"),"*".repeat(w.length)));
  return text;
}

function addMessage(user,text,nameC,avC){
  const div = document.createElement("div");
  div.className="message";
  div.innerHTML=`<span class="username" style="color:${nameC}">${user}</span>: <span class="text" style="color:${avC}">${text}</span>`;
  if(messagesEl.firstChild && messagesEl.firstChild.innerHTML === div.innerHTML) return;
  messagesEl.prepend(div);
}

function addUser(user,nameC,avC,online){
  if(document.getElementById("user_"+user)) return;
  const div = document.createElement("div");
  div.className="user";
  div.id="user_"+user;
  div.textContent=user+" "+(online?"ðŸŸ¢":"ðŸ”´");
  div.style.color=nameC;
  usersEl.appendChild(div);
}

function updateOnline(user,online){
  const el=document.getElementById("user_"+user);
  if(el) el.textContent=user+" "+(online?"ðŸŸ¢":"ðŸ”´");
}

async function fetchPresence(){
  try{
    const res = await fetch(`${API_URL}/presence?select=username,name_color,avatar_color,online`,{
      headers:{apikey:API_KEY,"Authorization":"Bearer "+API_KEY}
    });
    const data = await res.json();
    usersEl.innerHTML="";
    data.forEach(u=>addUser(u.username,u.name_color||"#FF0000",u.avatar_color||"#FF0000",u.online));
  }catch(e){console.error("presence fetch err",e);}
}

async function fetchMessages(){
  try{
    const res = await fetch(`${API_URL}/messages?select=user,text,created_at&order=created_at.asc&limit=200`,{
      headers:{apikey:API_KEY,"Authorization":"Bearer "+API_KEY}
    });
    const data = await res.json();
    messagesEl.innerHTML="";
    data.forEach(m=>addMessage(m.user,sanitize(m.text),nameColor,avatarColor));
  }catch(e){console.error("messages fetch err",e);}
}

async function goOnline(){
  try{
    await fetch(`${API_URL}/presence`,{
      method:"POST",
      headers:{apikey:API_KEY,"Authorization":"Bearer "+API_KEY,"Content-Type":"application/json"},
      body:JSON.stringify({username:USERNAME,online:true,name_color:nameColor,avatar_color:avatarColor,lastseen:new Date().toISOString()})
    });
  }catch(e){console.error("online err",e);}
}

async function sendMessage(){
  let text = sanitize(msgInput.value.trim());
  if(!text) return;
  await fetch(`${API_URL}/messages`,{
    method:"POST",
    headers:{apikey:API_KEY,"Authorization":"Bearer "+API_KEY,"Content-Type":"application/json"},
    body:JSON.stringify({user:USERNAME,text})
  });
  addMessage(USERNAME,text,nameColor,avatarColor);
  msgInput.value="";
}

msgInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}
});

document.getElementById("send").addEventListener("click",sendMessage);

document.querySelectorAll(".color-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    if(btn.dataset.type==="name") nameColor=btn.dataset.color;
    else avatarColor=btn.dataset.color;
    goOnline();
  });
});

document.getElementById("moreName").addEventListener("click",()=>{
  const c=prompt("Enter hex color for name","#FF0000");
  if(/^#[0-9A-F]{6}$/i.test(c)){nameColor=c;goOnline();}
});
document.getElementById("moreAvatar").addEventListener("click",()=>{
  const c=prompt("Enter hex color for avatar","#FF0000");
  if(/^#[0-9A-F]{6}$/i.test(c)){avatarColor=c;goOnline();}
});

fetchPresence();
fetchMessages();
goOnline();
setInterval(fetchPresence,5000);
setInterval(fetchMessages,3000);
</script>

</body>
</html>
