<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Vixel Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0b0b0b; --panel:#120101; --panel-2:#170303;
  --text:#f6f6f6; --subtle:#b7b1b1;
  --accent:#ff2b2b; --accent-2:#ff6b6b;
  --radius:12px; --shadow:0 10px 30px rgba(0,0,0,0.6);
  --input-bg:rgba(255,255,255,0.02);
}
*{box-sizing:border-box;}
body{margin:0; height:100%; font-family:Inter,sans-serif; background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px;}
.app{width:100%; max-width:1060px; height:90vh; background:linear-gradient(180deg,var(--panel),var(--panel-2)); border-radius:16px; display:flex; flex-direction:column; box-shadow:var(--shadow); overflow:hidden;}
.header{display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid rgba(255,255,255,0.05);}
.header .title{font-weight:700; font-size:20px; color:var(--accent);}
.main{flex:1; display:grid; grid-template-columns:1fr 300px; gap:12px; overflow:hidden;}
.chat, .sidebar{background:linear-gradient(180deg, rgba(255,0,0,0.015), rgba(0,0,0,0.03)); border-radius:12px; padding:12px; display:flex; flex-direction:column; overflow:auto;}
.chat .messages{flex:1; overflow:auto; display:flex; flex-direction:column; gap:8px;}
.msg-row{display:flex; gap:8px; align-items:flex-start;}
.avatar{width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff;}
.bubble{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); padding:8px 10px; border-radius:10px; flex:1;}
.bubble .username{font-weight:700;}
.bubble .ts{font-size:12px; color:var(--subtle);}
.footer{display:flex; gap:8px; padding-top:6px;}
.textarea{flex:1; min-height:48px; border-radius:8px; padding:8px; background:var(--input-bg); border:1px solid rgba(255,255,255,0.03); color:var(--text);}
.button{padding:6px 12px; border:none; border-radius:8px; background:linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff; cursor:pointer; font-weight:700;}
.sidebar .player-row{display:flex; align-items:center; gap:8px; margin-bottom:6px;}
.sidebar .player-avatar{width:28px;height:28px;border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff;}
@media(max-width:820px){.main{grid-template-columns:1fr 1fr;} .sidebar{order:2;}}
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <div class="title">Vixel Chat</div>
    <div id="net-status">• offline</div>
  </div>

  <div class="main">
    <div class="chat">
      <div class="messages" id="messages">Loading messages...</div>
      <div class="footer">
        <textarea id="input" class="textarea" placeholder="Enter message"></textarea>
        <button class="button" id="btn-send">Send</button>
      </div>
    </div>

    <div class="sidebar">
      <h3>Players</h3>
      <div id="players">Loading players...</div>
    </div>
  </div>
</div>

<script>
const MESSAGES_URL = 'https://ehciyxvbasqiiiurjuwu.supabase.co/functions/v1/quick-endpoint';
const USERS_URL = 'https://ehciyxvbasqiiiurjuwu.supabase.co/functions/v1/super-function';

// username/colors saved in localStorage
let username = localStorage.getItem('vixel-username');
let nameColor = localStorage.getItem('vixel-name-color') || '#ff2b2b';
let avatarColor = localStorage.getItem('vixel-avatar-color') || '#ff2b2b';

if(!username){
  username = prompt('Enter your username') || 'Guest'+Math.floor(Math.random()*999);
  localStorage.setItem('vixel-username', username);
  localStorage.setItem('vixel-name-color', nameColor);
  localStorage.setItem('vixel-avatar-color', avatarColor);
}

// render helpers
function renderMessages(list){
  const el = document.getElementById('messages');
  el.innerHTML = '';
  if(!list || !list.length){ el.textContent='No messages yet'; return; }
  list.forEach(m=>{
    const row = document.createElement('div'); row.className='msg-row';
    const av = document.createElement('div'); av.className='avatar'; av.textContent=(m.username||'U')[0].toUpperCase(); av.style.background=m.avatar_color||avatarColor;
    const bubble = document.createElement('div'); bubble.className='bubble';
    const header = document.createElement('div'); header.innerHTML=`<span class="username" style="color:${m.name_color||nameColor}">${m.username||'Unknown'}</span> <span class="ts">${new Date(m.created_at||Date.now()).toLocaleTimeString()}</span>`;
    const content = document.createElement('div'); content.textContent=m.text||'';
    bubble.appendChild(header); bubble.appendChild(content);
    row.appendChild(av); row.appendChild(bubble);
    el.appendChild(row);
  });
}

function renderPlayers(list){
  const el = document.getElementById('players');
  el.innerHTML='';
  if(!list||!list.length){ el.textContent='No players online'; return; }
  list.forEach(u=>{
    const row = document.createElement('div'); row.className='player-row';
    const av = document.createElement('div'); av.className='player-avatar'; av.textContent=(u.username||'U')[0].toUpperCase(); av.style.background=u.avatar_color||avatarColor;
    const text = document.createElement('span'); text.textContent=`${u.username||'Unknown'} ${u.online?'• online':'• offline'} last: ${u.lastseen||'—'}`; text.style.color=u.name_color||nameColor;
    row.appendChild(av); row.appendChild(text); el.appendChild(row);
  });
}

// fetch & update
async function loadMessages(){
  try{
    const res=await fetch(MESSAGES_URL);
    const data=await res.json();
    renderMessages(data);
    document.getElementById('net-status').textContent='• online';
    console.log('Messages:', data);
  }catch(e){
    console.error(e);
    document.getElementById('net-status').textContent='• offline';
  }
}

async function loadUsers(){
  try{
    const res=await fetch(USERS_URL);
    const data=await res.json();
    renderPlayers(data);
    console.log('Users:', data);
  }catch(e){
    console.error(e);
  }
}

// send message
document.getElementById('btn-send').addEventListener('click', async()=>{
  const input=document.getElementById('input');
  const text=input.value.trim();
  if(!text) return;
  input.value='';
  try{
    await fetch(MESSAGES_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({username,text,name_color:nameColor,avatar_color:avatarColor,created_at:new Date().toISOString()})
    });
    loadMessages();
  }catch(e){ console.error(e); }
});

// init + polling
loadMessages();
loadUsers();
setInterval(()=>{ loadMessages(); loadUsers(); },5000);
</script>

</body>
</html>
