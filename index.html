<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vixel Chat</title>

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ================= RESET ================= */
*{box-sizing:border-box}
body{
  margin:0;
  height:100vh;
  background:#0b0b0b;
  color:#fff;
  font-family:system-ui, -apple-system, BlinkMacSystemFont;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* ================= APP ================= */
.app{
  width:100%;
  max-width:1100px;
  height:92vh;
  background:#120101;
  border-radius:16px;
  display:flex;
  flex-direction:column;
  overflow:hidden;
  box-shadow:0 20px 60px rgba(0,0,0,.6);
}

/* ================= HEADER ================= */
header{
  background:#180101;
  padding:12px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header .title{
  font-weight:800;
  letter-spacing:.5px;
}
header .status{
  font-size:13px;
  opacity:.8;
}

/* ================= MAIN ================= */
main{
  flex:1;
  display:grid;
  grid-template-columns:1fr 280px;
  gap:10px;
  padding:10px;
  overflow:hidden;
}

/* ================= CHAT ================= */
.chat{
  background:#100000;
  border-radius:14px;
  display:flex;
  flex-direction:column;
  padding:10px;
}
.messages{
  flex:1;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.msg{
  display:flex;
  gap:10px;
}
.avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
}
.bubble{
  background:#1b0202;
  padding:8px 12px;
  border-radius:10px;
  max-width:80%;
}
.name{
  font-weight:700;
  font-size:14px;
}
.text{
  font-size:14px;
  line-height:1.4;
}
.time{
  font-size:11px;
  opacity:.5;
}

/* ================= INPUT ================= */
.input{
  display:flex;
  gap:8px;
  margin-top:8px;
}
textarea{
  flex:1;
  resize:none;
  border:none;
  border-radius:10px;
  padding:10px;
  font-size:14px;
}
button{
  background:#ff2b2b;
  border:none;
  border-radius:10px;
  padding:0 18px;
  font-weight:800;
  color:#fff;
  cursor:pointer;
}

/* ================= SIDEBAR ================= */
.sidebar{
  background:#100000;
  border-radius:14px;
  padding:10px;
  overflow-y:auto;
}
.player{
  display:flex;
  gap:8px;
  align-items:center;
  margin-bottom:8px;
}
.p-avatar{
  width:28px;
  height:28px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
}
.offline{opacity:.4}

/* ================= MOBILE ================= */
@media(max-width:900px){
  main{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div class="app">
<header>
  <div class="title">Vixel Chat</div>
  <div class="status" id="status">connecting…</div>
</header>

<main>
  <div class="chat">
    <div class="messages" id="messages"></div>
    <div class="input">
      <textarea id="input" rows="2" placeholder="Type message…"></textarea>
      <button id="send">Send</button>
    </div>
  </div>

  <div class="sidebar">
    <b>Players</b>
    <div id="players"></div>
  </div>
</main>
</div>

<script>
/* ======================================================
   CONFIG
====================================================== */
const SUPABASE_URL = "https://ehciyxvbasqiiiurjuwu.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoY2l5eHZiYXNxaWlpdXJqdXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzQzNTgsImV4cCI6MjA3OTY1MDM1OH0.yMZ8EqtPXJumjn2xHTXwG3jbWTNdDxrklYIkdXNcbQk";

/* ======================================================
   INIT
====================================================== */
const supabase = supabaseJs.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);

/* ======================================================
   USER IDENTITY (LOCKED)
====================================================== */
let username = localStorage.getItem("vixel-username");
if(!username){
  username = prompt("Choose a username");
  if(!username) location.reload();
  localStorage.setItem("vixel-username", username);
}

const name_color = "#ff2b2b";
const avatar_color = "#ff2b2b";

/* ======================================================
   RATE LIMIT
====================================================== */
let lastSend = 0;
const SEND_COOLDOWN = 1200;

/* ======================================================
   PRESENCE (AUTO CLEAN)
====================================================== */
async function heartbeat(online=true){
  await fetch("https://ehciyxvbasqiiiurjuwu.supabase.co/functions/v1/super-function",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      username,
      online,
      name_color,
      avatar_color
    })
  });
}

heartbeat(true);
setInterval(()=>heartbeat(true), 5000);
window.addEventListener("beforeunload", ()=>heartbeat(false));
document.addEventListener("visibilitychange",()=>{
  heartbeat(document.visibilityState === "visible");
});

/* ======================================================
   RENDER
====================================================== */
function renderMessage(m){
  const el = document.createElement("div");
  el.className = "msg";
  el.innerHTML = `
    <div class="avatar" style="background:${m.avatar_color}">
      ${m.username[0].toUpperCase()}
    </div>
    <div class="bubble">
      <div class="name" style="color:${m.name_color}">
        ${m.username}
      </div>
      <div class="text">${m.text}</div>
      <div class="time">${new Date(m.created_at).toLocaleTimeString()}</div>
    </div>
  `;
  document.getElementById("messages").appendChild(el);
  document.getElementById("messages").scrollTop =
    document.getElementById("messages").scrollHeight;
}

function renderPlayers(list){
  const box = document.getElementById("players");
  box.innerHTML = "";
  list.forEach(u=>{
    const row = document.createElement("div");
    row.className = "player" + (u.online ? "" : " offline");
    row.innerHTML = `
      <div class="p-avatar" style="background:${u.avatar_color}">
        ${u.username[0].toUpperCase()}
      </div>
      <span style="color:${u.name_color}">
        ${u.username} ${u.online ? "• online" : "• offline"}
      </span>
    `;
    box.appendChild(row);
  });
}

/* ======================================================
   LOAD INITIAL DATA
====================================================== */
async function loadInitial(){
  const { data: msgs } = await supabase
    .from("messages")
    .select("*")
    .order("created_at",{ ascending:true })
    .limit(200);

  msgs.forEach(renderMessage);

  const { data: users } = await supabase
    .from("users")
    .select("*");

  renderPlayers(users);
  document.getElementById("status").textContent = "online";
}

loadInitial();

/* ======================================================
   REALTIME
====================================================== */
supabase
  .channel("chat-realtime")
  .on(
    "postgres_changes",
    { event:"INSERT", schema:"public", table:"messages" },
    payload => renderMessage(payload.new)
  )
  .on(
    "postgres_changes",
    { event:"UPDATE", schema:"public", table:"users" },
    async ()=>{
      const { data } = await supabase.from("users").select("*");
      renderPlayers(data);
    }
  )
  .subscribe();

/* ======================================================
   SEND MESSAGE
====================================================== */
document.getElementById("send").onclick = async()=>{
  const now = Date.now();
  if(now - lastSend < SEND_COOLDOWN) return;
  lastSend = now;

  const input = document.getElementById("input");
  const text = input.value.trim();
  if(!text) return;

  input.value = "";

  await fetch("https://ehciyxvbasqiiiurjuwu.supabase.co/functions/v1/quick-endpoint",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      username,
      text,
      name_color,
      avatar_color
    })
  });
};
</script>
</body>
</html>
