<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vixel Chat — Server Powered</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@500&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0b0b;
    --panel:#120101;
    --panel-2:#170303;
    --accent:#ff2b2b;
    --accent-2:#ff6b6b;
    --text:#f6f6f6;
    --subtle:#b7b1b1;
    --radius:12px;
    --shadow:0 10px 30px rgba(0,0,0,0.6);
    --input-bg:rgba(255,255,255,0.02);
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text);display:flex;justify-content:center;align-items:center;height:100vh;padding:10px}
  .app{width:100%;max-width:1060px;height:90%;background:linear-gradient(180deg,var(--panel),var(--panel-2));border-radius:16px;padding:16px;display:flex;flex-direction:column;gap:12px;box-shadow:var(--shadow)}
  .header{display:flex;justify-content:space-between;align-items:center}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:50px;height:50px;border-radius:12px;background:linear-gradient(180deg,rgba(255,0,0,0.08),rgba(0,0,0,0.15));display:flex;justify-content:center;align-items:center;font-family:Orbitron;font-weight:700;color:var(--accent);font-size:20px;border:1px solid rgba(255,255,255,0.03)}
  .main{flex:1;display:flex;gap:12px;overflow:hidden;border-radius:12px}
  .chat{flex:1;background:linear-gradient(180deg,rgba(255,0,0,0.015),rgba(0,0,0,0.03));padding:12px;display:flex;flex-direction:column;gap:10px;overflow:hidden;border-radius:12px}
  .messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:10px;padding-right:6px;scroll-behavior:smooth}
  .msg-row{display:flex;gap:10px;align-items:flex-start}
  .avatar{width:40px;height:40px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:700;color:#fff;background:var(--accent)}
  .bubble{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.02));padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);max-width:80%}
  .bubble-header{display:flex;justify-content:space-between;align-items:center;gap:6px}
  .username{font-weight:700}
  .ts{font-size:12px;color:var(--subtle)}
  .msg-text{margin-top:4px;line-height:1.35;word-break:break-word}
  .footer{display:flex;gap:8px;align-items:center;padding-top:6px}
  .textarea{flex:1;min-height:50px;padding:8px;border-radius:8px;background:var(--input-bg);border:1px solid rgba(255,255,255,0.03);color:var(--text)}
  .button{background:linear-gradient(180deg,var(--accent),var(--accent-2));border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
  .sidebar{width:280px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.02));border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px;overflow-y:auto}
  .player-row{display:flex;gap:10px;align-items:center;padding:6px;border-radius:8px}
  .player-avatar{width:36px;height:36px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:700;color:#fff;background:var(--accent)}
  @media(max-width:820px){.main{flex-direction:column}.sidebar{width:100%}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">
      <div class="logo">V</div>
      <div>
        <div class="title">Vixel Chat</div>
        <div class="subtitle">Server-powered • Red Theme</div>
      </div>
    </div>
  </div>

  <div class="main">
    <section class="chat">
      <div class="messages" id="messages"></div>
      <div class="footer">
        <textarea id="input" class="textarea" placeholder="Enter to send…"></textarea>
        <button id="btn-send" class="button">Send</button>
      </div>
    </section>

    <aside class="sidebar">
      <h3>Players</h3>
      <div id="players-list"></div>
    </aside>
  </div>
</div>

<script>
const MESSAGES_API = "https://ehciyxvbasqiiiurjuwu.supabase.co/functions/v1/super-function";
const USERS_API = "https://ehciyxvbasqiiiurjuwu.supabase.co/functions/v1/super-function";

let username = localStorage.getItem("vixel-username");
let nameColor = localStorage.getItem("vixel-name-color")||"#ff2b2b";
let avatarColor = localStorage.getItem("vixel-avatar-color")||"#ff2b2b";

if(!username){
  username = prompt("Enter your username") || "Guest"+Math.floor(Math.random()*999);
  localStorage.setItem("vixel-username", username);
  localStorage.setItem("vixel-name-color", nameColor);
  localStorage.setItem("vixel-avatar-color", avatarColor);
}

const messagesEl = document.getElementById("messages");
const playersListEl = document.getElementById("players-list");
const inputEl = document.getElementById("input");
const btnSend = document.getElementById("btn-send");

const sleep = ms=>new Promise(r=>setTimeout(r,ms));
const nowISO = ()=>new Date().toISOString();

async function fetchMessages(){
  try{
    const res = await fetch(MESSAGES_API, { method:"GET" });
    if(!res.ok) throw new Error("Fetch messages failed");
    return await res.json();
  }catch(e){console.error(e);return[]}
}

async function renderMessages(){
  const list = await fetchMessages();
  messagesEl.innerHTML = "";
  list.forEach(m=>{
    const row = document.createElement("div");
    row.className="msg-row";

    const av = document.createElement("div");
    av.className="avatar";
    av.style.background = m.avatar_color||avatarColor;
    av.textContent = (m.username||"U")[0].toUpperCase();

    const bubble = document.createElement("div");
    bubble.className="bubble";

    const header = document.createElement("div");
    header.className="bubble-header";

    const uname = document.createElement("div");
    uname.className="username";
    uname.style.color=m.name_color||nameColor;
    uname.textContent = m.username||m.user||"Unknown";

    const ts = document.createElement("div");
    ts.className="ts";
    ts.textContent = new Date(m.created_at).toLocaleTimeString();

    header.appendChild(uname);
    header.appendChild(ts);

    const content = document.createElement("div");
    content.className="msg-text";
    content.textContent = m.text;

    bubble.appendChild(header);
    bubble.appendChild(content);
    row.appendChild(av);
    row.appendChild(bubble);
    messagesEl.appendChild(row);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function updateUser(online=true){
  try{
    await fetch(USERS_API, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        username,
        online,
        lastseen: nowISO(),
        name_color: nameColor,
        avatar_color: avatarColor
      })
    });
  }catch(e){console.error(e)}
}

async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value="";
  try{
    await fetch(MESSAGES_API, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({username,user:username,text,name_color:nameColor,avatar_color:avatarColor})
    });
    await renderMessages();
  }catch(e){console.error(e)}
}

btnSend.addEventListener("click",sendMessage);
inputEl.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){ e.preventDefault(); sendMessage(); }
});

async function loop(){
  while(true){
    await updateUser(true);
    await renderMessages();
    await sleep(5000);
  }
}
loop();

window.addEventListener("beforeunload",()=>updateUser(false));
</script>
</body>
</html>
