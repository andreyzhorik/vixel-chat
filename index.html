<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vixel Chat</title>

<style>
  :root{
    --bg:#000000;
    --panel:#160000;
    --panel2:#1d0000;
    --accent1:#5A0000;
    --accent2:#C00000;
    --accent3:#FF2A2A;
    --text:#ffffff;
    --muted:#bbbbbb;
  }

  html,body{
    height:100%;
    margin:0;
    background:linear-gradient(180deg,var(--bg),#300000);
  }

  body{
    font-family:Inter,system-ui;
    color:var(--text);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
  }

  .app{
    width:100%;
    max-width:1100px;
    height:80vh;
    display:grid;
    grid-template-columns:3fr 1fr;
    gap:18px;
  }

  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border-radius:16px;
    padding:14px;
    box-shadow:0 10px 40px rgba(0,0,0,0.7);
    display:flex;
    flex-direction:column;
    border:1px solid #3a0000;
  }

  /* HEADER */
  .header{
    display:flex;
    align-items:center;
    gap:14px;
    margin-bottom:12px;
    padding-bottom:10px;
    border-bottom:1px solid rgba(255,255,255,0.1);
  }

  .logo{
    width:60px;
    height:60px;
    border-radius:12px;
    background:#300;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .logo img{
    width:100%;
    height:100%;
    object-fit:contain;
  }

  .title{font-size:22px;font-weight:700;}

  /* CHAT */
  .chat{
    flex:1;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .chatMessages{
    flex:1;
    overflow-y:auto;
    padding:10px;
    border-radius:10px;
    background:rgba(0,0,0,0.22);
    backdrop-filter:blur(6px);
  }

  .msg{
    margin:10px 0;
    padding:10px 12px;
    border-radius:12px;
    max-width:75%;
    background:#240000;
    box-shadow:0 0 8px rgba(255,0,0,0.2);
    display:flex;
    gap:10px;
  }

  .own{
    background:#4a0000;
    margin-left:auto;
  }

  .avatar{
    width:26px;
    height:26px;
    border-radius:6px;
    background:var(--accent3);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    color:white;
    flex-shrink:0;
  }

  .msg .who{
    font-weight:700;
    color:var(--accent3);
  }

  /* INPUTS */
  .inputRow{
    display:flex;
    gap:10px;
    padding-top:12px;
  }

  input{
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.15);
    color:var(--text);
    padding:10px;
    border-radius:8px;
    flex:1;
  }

  .btn{
    background:linear-gradient(90deg,var(--accent2),var(--accent3));
    padding:10px 14px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    color:white;
    font-weight:600;
    box-shadow:0 0 8px rgba(255,0,0,0.4);
  }

  /* PLAYERS */
  .players{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .playerList{
    overflow:auto;
    flex:1;
    padding:8px;
    background:rgba(0,0,0,0.22);
    border-radius:10px;
  }

  .player{
    display:flex;
    align-items:center;
    gap:10px;
    padding:8px;
    border-radius:10px;
    background:rgba(255,255,255,0.04);
    margin-bottom:6px;
  }

  .player .avatar{
    background:var(--accent2);
  }

  .dot{
    width:10px;
    height:10px;
    border-radius:50%;
  }

  .online{background:var(--accent3);}
  .offline{background:#555;}
</style>
</head>

<body>
<div class="app">

  <!-- CHAT PANEL -->
  <div class="card">

    <div class="header">
      <div class="logo">
        <img src="https://raw.githubusercontent.com/andreyzhorik/VIXEL/main/logonobg.png">
      </div>

      <div>
        <div class="title">Vixel Chat</div>
        <div class="small" style="color:var(--muted)">brighter red theme</div>
      </div>

      <div style="margin-left:auto;color:var(--muted)" id="statusBadge">not connected</div>
    </div>

    <div class="chat">
      <div id="chatMessages" class="chatMessages"></div>
    </div>

    <div class="inputRow">
      <input id="messageInput" type="text" placeholder="Type a message..." />
      <button id="sendBtn" class="btn">Send</button>
    </div>

    <div style="margin-top:10px;display:flex;gap:10px;align-items:center;">
      <input id="nameInput" placeholder="your name" />
      <button id="loginBtn" class="btn">Set Name</button>
    </div>
  </div>

  <!-- PLAYERS PANEL -->
  <div class="card players">
    <div style="display:flex;justify-content:space-between;">
      <strong>Players</strong>
      <div id="onlineCount" style="color:var(--muted)">0 online</div>
    </div>
    <div id="playerList" class="playerList"></div>
  </div>

</div>

<script>
const WORKER_URL = "https://vixel-chat.mrviktor2426.workers.dev";

let token = localStorage.getItem('vixel_token');
let username = localStorage.getItem('vixel_user');
let lastMsgId = 0;

const POLL = 2000;
const PRESENCE = 8000;

const chatBox = document.getElementById("chatMessages");
const playerListEl = document.getElementById("playerList");
const statusBadge = document.getElementById("statusBadge");
const msgInput = document.getElementById("messageInput");
const nameInput = document.getElementById("nameInput");

function escapeHtml(t){
  return t.replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]) );
}

function setStatus(t){
  statusBadge.textContent = t;
}

async function API(path, method="GET", body=null){
  const h = {"Accept":"application/json"};
  if(token) h["Authorization"] = "Bearer "+token;
  if(body) h["Content-Type"] = "application/json";

  const res = await fetch(WORKER_URL + path,{
    method,
    headers:h,
    body:body ? JSON.stringify(body) : null
  });

  if(!res.ok) throw new Error(await res.text());
  return res.json();
}

async function setName(){
  const name = nameInput.value.trim();
  if(!name) return alert("enter a name bro");

  try{
    const r = await API("/register","POST",{name});
    token = r.token;
    username = name;
    localStorage.setItem("vixel_token",token);
    localStorage.setItem("vixel_user",name);
    setStatus("connected as "+name);
    nameInput.value = "";
  }catch(e){
    alert("name issue: "+e.message);
  }
}

async function sendMessage(){
  const t = msgInput.value.trim();
  if(!t) return;

  try{
    await API("/send","POST",{text:t});
    msgInput.value = "";
    fetchMessages();
  }catch(e){
    alert("send fail: "+e.message);
  }
}

async function fetchMessages(){
  try{
    const r = await API("/messages?after="+lastMsgId);

    if(r.messages?.length){
      lastMsgId = r.messages[r.messages.length-1].id;

      chatBox.innerHTML = r.all.map(m => `
        <div class="msg ${m.user === username ? "own" : ""}">
          <div class="avatar">${m.user[0].toUpperCase()}</div>
          <div>
            <div class="who">${escapeHtml(m.user)}</div>
            <div>${escapeHtml(m.text)}</div>
          </div>
        </div>
      `).join("");

      chatBox.scrollTop = chatBox.scrollHeight;
    }
  }catch(e){}
}

async function fetchPlayers(){
  try{
    const r = await API("/players");
    const now = Date.now();
    let onlineCount = 0;

    playerListEl.innerHTML = r.players.map(p=>{
      const isOnline = (now - p.lastSeen) < 20000;
      if(isOnline) onlineCount++;

      return `
        <div class="player">
          <div class="dot ${isOnline ? "online" : "offline"}"></div>
          <div class="avatar">${p.name[0].toUpperCase()}</div>
          <strong>${escapeHtml(p.name)}</strong>
        </div>
      `;
    }).join("");

    document.getElementById("onlineCount").textContent = onlineCount + " online";
  }catch(e){
    playerListEl.innerHTML = "<div style='color:red;'>Failed to load players</div>";
  }
}

async function heartbeat(){
  try{ await API("/presence","POST"); }catch(e){}
}

document.getElementById("loginBtn").onclick = setName;
document.getElementById("sendBtn").onclick = sendMessage;
msgInput.addEventListener("keydown",e=>{
  if(e.key==="Enter") sendMessage();
});

setInterval(fetchMessages,POLL);
setInterval(()=>{heartbeat();fetchPlayers();},PRESENCE);

(async ()=>{
  if(token && username){
    setStatus("connected as "+username);
    await heartbeat();
    fetchMessages();
    fetchPlayers();
  }
})();
</script>
</body>
</html>
