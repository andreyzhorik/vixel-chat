<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vixel Chat</title>
<style>
  :root{
    --bg:#000000;
    --panel:#150000;
    --panel2:#1b0000;
    --accent1:#5A0000;
    --accent2:#C00000;
    --accent3:#FF2A2A;
    --text:#ffffff;
    --muted:#bbbbbb;
  }

  html,body{
    height:100%;
    margin:0;
    overflow:hidden; /* prevent page scroll; only messages scroll */
    background:linear-gradient(180deg,var(--bg),#1b0000);
    font-family:Inter,system-ui,Arial;
    color:var(--text);
  }

  .wrap{
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
    box-sizing:border-box;
  }

  .app{
    width:100%;
    max-width:1100px;
    height:80vh;
    display:grid;
    grid-template-columns:3fr 1fr;
    gap:18px;
    min-height:0;
  }

  .card{
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border-radius:14px;
    padding:12px;
    box-shadow:0 8px 30px rgba(0,0,0,0.7);
    display:flex;
    flex-direction:column;
    border:1px solid rgba(255,0,0,0.04);
    min-height:0; /* important for flex children to scroll */
  }

  .header{
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:8px;
  }

  .logo{
    width:52px;
    height:52px;
    border-radius:10px;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    background:transparent;
  }
  .logo img{ width:100%; height:100%; object-fit:contain; }

  .title{font-size:20px;}
  .sub{color:var(--muted);font-size:13px;}

  /* ONLY messages scroll */
  .messages {
    flex:1;
    overflow-y:auto;
    padding:12px;
    border-radius:8px;
    background:rgba(0,0,0,0.20);
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:0; /* crucial */
    scroll-behavior:smooth;
  }

  .msg{
    max-width:78%;
    padding:10px 12px;
    border-radius:12px;
    display:flex;
    gap:10px;
    align-items:flex-start;
    background:rgba(255,255,255,0.03);
    box-shadow:0 6px 18px rgba(0,0,0,0.45);
    word-break:break-word;
    animation:pop .12s ease;
  }
  @keyframes pop { from{opacity:0; transform:translateY(6px) scale(.99);} to{opacity:1; transform:none;} }

  .avatar{ width:34px; height:34px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; background:var(--accent3); flex-shrink:0; }
  .meta{ font-weight:700; color:var(--muted); margin-bottom:4px; font-size:13px; }
  .text{ font-size:15px; color:#fff; line-height:1.35; }

  .msg.own{ margin-left:auto; background:linear-gradient(180deg, rgba(255,30,30,0.12), rgba(255,0,0,0.04)); border:1px solid rgba(255,0,0,0.08); }
  .msg.other{ margin-right:auto; background:linear-gradient(180deg, rgba(80,0,0,0.10), rgba(40,0,0,0.03)); border:1px solid rgba(255,255,255,0.02); }

  .time{ font-size:12px; color:var(--muted); margin-left:8px; align-self:flex-end; }

  .inputRow{
    display:flex;
    gap:8px;
    padding-top:10px;
  }

  input[type="text"]{
    background:transparent;
    border:1px solid rgba(255,255,255,0.12);
    color:var(--text);
    padding:10px;
    border-radius:8px;
    outline:none;
    flex:1;
  }

  .btn{
    background:linear-gradient(90deg,var(--accent2),var(--accent3));
    padding:10px 14px;
    border-radius:8px;
    border:none;
    color:white;
    cursor:pointer;
    font-weight:700;
  }

  .players{
    display:flex;
    flex-direction:column;
    gap:8px;
    height:100%;
  }

  .playerList{
    overflow:hidden; /* no scroll here; only messages scroll */
    flex:1;
    padding:6px;
    background:rgba(0,0,0,0.18);
    border-radius:8px;
  }

  .player{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px;
    border-radius:8px;
    background:rgba(255,255,255,0.02);
  }

  .dot{ width:10px; height:10px; border-radius:50%; }
  .dot.online{ background:var(--accent2); box-shadow:0 0 6px rgba(255,0,0,0.12); }
  .dot.offline{ background:#444; }

  .small{ color:var(--muted); font-size:13px; }

  @media(min-width:1100px){
    .logo{ width:64px; height:64px; border-radius:12px; }
    .avatar{ width:40px; height:40px; border-radius:10px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="app">

    <!-- CHAT PANEL -->
    <div class="card" id="chatCard">
      <div class="header">
        <div class="logo"><img src="https://raw.githubusercontent.com/andreyzhorik/VIXEL/main/logonobg.png" alt="vixel"></div>
        <div>
          <div class="title">Vixel Chat</div>
          <div class="sub">server-backed â€” everyone sees messages</div>
        </div>
        <div style="margin-left:auto;" id="statusBadge" class="small">not connected</div>
      </div>

      <div id="messages" class="messages"></div>

      <div class="inputRow">
        <input id="messageInput" type="text" placeholder="Type a message..." autocomplete="off" />
        <button id="sendBtn" class="btn">Send</button>
      </div>

      <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
        <input id="nameInput" placeholder="your name" style="flex:1" />
        <button id="loginBtn" class="btn">Set Name</button>
      </div>
    </div>

    <!-- PLAYERS PANEL -->
    <div class="card players">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <strong>Players</strong>
        <div id="onlineCount" class="small">0 online</div>
      </div>
      <div id="playerList" class="playerList"></div>
    </div>

  </div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // Supabase config
  const supabaseUrl = "https://ehciyxvbasqiiiurjuwu.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoY2l5eHZiYXNxaWlpdXJqdXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzQzNTgsImV4cCI6MjA3OTY1MDM1OH0.yMZ8EqtPXJumjn2xHTXwG3jbWTNdDxrklYIkdXNcbQk";
  const supabase = createClient(supabaseUrl, supabaseKey);

  // Elements
  const chatEl = document.getElementById("chat");
  const msgInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const nameInput = document.getElementById("nameInput");
  const loginBtn = document.getElementById("loginBtn");

  // Username saved locally
  let username = localStorage.getItem("vixel_user") || "";

  // Add a message to DOM
  function addMessage(msg) {
    const div = document.createElement("div");
    div.className = "msg";
    div.innerHTML = `<strong>${msg.user}:</strong> ${msg.text}`;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  // Fetch existing messages
  async function loadMessages() {
    const { data, error } = await supabase
      .from("messages")
      .select("*")
      .order("ts", { ascending: true });

    if (!data) return;

    chatEl.innerHTML = "";
    data.forEach(addMessage);
  }

  // Send a message
  async function sendMessage() {
    const text = msgInput.value.trim();
    if (!username) return alert("Enter your name first");
    if (!text) return;

    await supabase.from("messages").insert([
      { user: username, text }
    ]);

    msgInput.value = "";
  }

  // Login / set name
  loginBtn.onclick = () => {
    const name = nameInput.value.trim();
    if (!name) return;
    username = name;
    localStorage.setItem("vixel_user", name);
    nameInput.value = "";
  };

  // Send on click or Enter
  sendBtn.onclick = sendMessage;
  msgInput.addEventListener("keydown", e => {
    if (e.key === "Enter") sendMessage();
  });

  // Realtime updates
  supabase
    .channel("realtime:messages")
    .on(
      "postgres_changes",
      { event: "INSERT", schema: "public", table: "messages" },
      (payload) => addMessage(payload.new)
    )
    .subscribe();

  // Load old messages on page load
  loadMessages();
</script>
</body>
</html>
