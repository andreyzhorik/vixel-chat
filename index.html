<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Vixel Chat</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  height:100vh;
  background:#0b0b0b;
  font-family:system-ui, sans-serif;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
}
.app{
  width:100%;
  max-width:1000px;
  height:90vh;
  background:#120101;
  border-radius:14px;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
header{
  background:#180101;
  padding:10px 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:700;
}
main{
  flex:1;
  display:grid;
  grid-template-columns:1fr 260px;
  gap:8px;
  padding:8px;
  overflow:hidden;
}
.chat{
  background:#100000;
  border-radius:10px;
  display:flex;
  flex-direction:column;
  padding:8px;
}
.messages{
  flex:1;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.msg{
  display:flex;
  gap:8px;
}
.avatar{
  width:34px;
  height:34px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  color:#fff;
}
.bubble{
  background:#1a0202;
  padding:6px 10px;
  border-radius:8px;
}
.name{
  font-weight:700;
  font-size:14px;
}
.text{
  font-size:14px;
}
.time{
  font-size:11px;
  opacity:.6;
}
.input{
  display:flex;
  gap:6px;
  margin-top:6px;
}
textarea{
  flex:1;
  resize:none;
  border-radius:8px;
  padding:8px;
  border:none;
  outline:none;
}
button{
  border:none;
  border-radius:8px;
  padding:0 16px;
  background:#ff2b2b;
  color:#fff;
  font-weight:700;
  cursor:pointer;
}
.sidebar{
  background:#100000;
  border-radius:10px;
  padding:8px;
  overflow-y:auto;
}
.player{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:6px;
}
.p-avatar{
  width:26px;
  height:26px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
}
@media(max-width:800px){
  main{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div class="app">
<header>
  <div>Vixel Chat</div>
  <div id="status">offline</div>
</header>

<main>
  <div class="chat">
    <div id="messages" class="messages">Loading…</div>
    <div class="input">
      <textarea id="input" rows="2" placeholder="Type message"></textarea>
      <button id="send">Send</button>
    </div>
  </div>

  <div class="sidebar">
    <b>Players</b>
    <div id="players">Loading…</div>
  </div>
</main>
</div>

<script>
const MSG_API = "https://ehciyxvbasqiiiurjuwu.supabase.co/functions/v1/quick-endpoint";
const USER_API = "https://ehciyxvbasqiiiurjuwu.supabase.co/functions/v1/super-function";

/* ---------- identity ---------- */
let username = localStorage.getItem("vixel_user");
if(!username){
  username = prompt("Username") || "Guest"+Math.floor(Math.random()*999);
  localStorage.setItem("vixel_user", username);
}
const name_color = "#ff2b2b";
const avatar_color = "#ff2b2b";

/* ---------- user ping ---------- */
async function updateUser(online){
  await fetch(USER_API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      username,
      online,
      name_color,
      avatar_color
    })
  });
}

/* ---------- messages ---------- */
async function loadMessages(){
  try{
    const r = await fetch(MSG_API);
    const data = await r.json();
    const box = document.getElementById("messages");
    box.innerHTML = "";

    if(!Array.isArray(data) || !data.length){
      box.textContent = "No messages";
      return;
    }

    data.forEach(m=>{
      const row = document.createElement("div");
      row.className = "msg";

      const av = document.createElement("div");
      av.className = "avatar";
      av.style.background = m.avatar_color;
      av.textContent = m.username[0].toUpperCase();

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = `
        <div class="name" style="color:${m.name_color}">${m.username}</div>
        <div class="text">${m.text}</div>
        <div class="time">${new Date(m.created_at).toLocaleTimeString()}</div>
      `;

      row.appendChild(av);
      row.appendChild(bubble);
      box.appendChild(row);
    });

    document.getElementById("status").textContent = "online";
  }catch{
    document.getElementById("status").textContent = "offline";
  }
}

/* ---------- players ---------- */
async function loadPlayers(){
  const r = await fetch(USER_API);
  const data = await r.json();
  const box = document.getElementById("players");
  box.innerHTML = "";

  if(!Array.isArray(data) || !data.length){
    box.textContent = "No players";
    return;
  }

  data.forEach(u=>{
    const row = document.createElement("div");
    row.className = "player";

    const av = document.createElement("div");
    av.className = "p-avatar";
    av.style.background = u.avatar_color;
    av.textContent = u.username[0].toUpperCase();

    const t = document.createElement("span");
    t.textContent = `${u.username} ${u.online ? "• online" : "• offline"}`;
    t.style.color = u.name_color;

    row.appendChild(av);
    row.appendChild(t);
    box.appendChild(row);
  });
}

/* ---------- send ---------- */
document.getElementById("send").onclick = async()=>{
  const input = document.getElementById("input");
  if(!input.value.trim()) return;

  await fetch(MSG_API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      username,
      text: input.value,
      name_color,
      avatar_color
    })
  });

  input.value="";
  loadMessages();
};

/* ---------- lifecycle ---------- */
updateUser(true);
loadMessages();
loadPlayers();

setInterval(()=>{
  updateUser(true);
  loadMessages();
  loadPlayers();
}, 4000);

window.addEventListener("beforeunload", ()=>updateUser(false));
</script>

</body>
</html>
