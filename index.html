<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vixel Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
<style>
  /* ROOT COLORS */
  :root {
    --bg: #000000;
    --panel: #1a0000;
    --accent: #FF0000;
    --text: #fff;
    --input-bg: #3D0000;
    --neon-shadow: 0 0 5px #FF0000, 0 0 10px #FF0000, 0 0 20px #FF0000;
  }

  * { box-sizing: border-box; font-family: 'Orbitron', sans-serif; }

  body { margin: 0; background: var(--bg); color: var(--text); display: flex; justify-content: center; }

  /* CONTAINER */
  #chat-container {
    width: 1000px; height: 700px; display: grid; grid-template-columns: 3fr 1fr; grid-template-rows: auto 1fr auto;
    gap: 10px; padding: 10px;
  }

  /* HEADER */
  #header {
    grid-column: 1 / 3; display: flex; align-items: center; justify-content: space-between;
  }
  #header img { height: 60px; background: black; border-radius: 10px; }

  /* MESSAGES PANEL */
  #messages-panel {
    grid-column: 1 / 2; grid-row: 2; background: var(--panel); border-radius: 10px; padding: 10px;
    overflow-y: auto; display: flex; flex-direction: column; gap: 5px;
  }
  .message { padding: 5px 10px; border-radius: 5px; background: #300000; display: flex; align-items: center; gap: 10px; box-shadow: var(--neon-shadow); }
  .message .username { font-weight: bold; }
  .message .text { white-space: pre-wrap; }

  /* USERS PANEL */
  #users-panel {
    grid-column: 2 / 3; grid-row: 2; background: var(--panel); border-radius: 10px; padding: 10px;
    overflow-y: auto;
  }
  .user { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
  .user .avatar { width: 20px; height: 20px; border-radius: 50%; background: red; }
  .user.online .avatar { box-shadow: 0 0 5px lime, 0 0 10px lime; }

  /* INPUT AREA */
  #input-area { grid-column: 1 / 3; display: flex; gap: 10px; }
  #message-input { flex: 1; background: var(--input-bg); color: var(--text); border: none; padding: 10px; border-radius: 5px; }
  #send-btn, #color-btn { background: var(--accent); color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; box-shadow: var(--neon-shadow); }

  /* COLOR PICKER MODAL */
  #color-picker { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                  background: #1a0000; padding: 20px; border-radius: 10px; box-shadow: var(--neon-shadow); }
  #color-picker input { margin-bottom: 10px; width: 100%; padding: 5px; border-radius: 5px; border: none; }

</style>
</head>
<body>
<div id="chat-container">
  <div id="header">
    <img src="https://raw.githubusercontent.com/andreyzhorik/VIXEL/main/logonobg.png" alt="Vixel Logo">
    <button id="color-btn">More</button>
  </div>

  <div id="messages-panel"></div>
  <div id="users-panel"></div>

  <div id="input-area">
    <textarea id="message-input" rows="2" placeholder="Shift+Enter = new line"></textarea>
    <button id="send-btn">Send</button>
  </div>
</div>

<div id="color-picker">
  <label>Name Color (hex):</label>
  <input type="text" id="name-color" placeholder="#FF0000">
  <label>Avatar Color (hex):</label>
  <input type="text" id="avatar-color" placeholder="#FF0000">
  <button id="save-colors">Save</button>
</div>

<script>
const SUPABASE_URL = "https://ehciyxvbasqiiiurjuwu.supabase.co";
const SUPABASE_KEY = "YOUR_ANON_KEY"; // replace with yours
const username = prompt("Enter your username:");
let nameColor = "#FF0000", avatarColor = "#FF0000";

// DOM
const messagesPanel = document.getElementById("messages-panel");
const usersPanel = document.getElementById("users-panel");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");
const colorBtn = document.getElementById("color-btn");
const colorPicker = document.getElementById("color-picker");
const saveColorsBtn = document.getElementById("save-colors");
const nameInput = document.getElementById("name-color");
const avatarInput = document.getElementById("avatar-color");

// EVENTS
sendBtn.onclick = sendMessage;
messageInput.onkeydown = e => { if (e.shiftKey && e.key === "Enter") { e.stopPropagation(); return; } if (e.key === "Enter") { e.preventDefault(); sendMessage(); } };
colorBtn.onclick = () => { colorPicker.style.display = "block"; }
saveColorsBtn.onclick = () => { nameColor = nameInput.value || "#FF0000"; avatarColor = avatarInput.value || "#FF0000"; colorPicker.style.display = "none"; savePresence(); }

// Anti-spam & badwords
const badWords = ["badword1","badword2"];
function cleanText(text) {
  badWords.forEach(bw => { text = text.replaceAll(bw, "***"); });
  return text;
}

// Supabase REST helpers
async function fetchPresence() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/presence?select=*`, {
      headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
    });
    return await res.json();
  } catch(e){ console.error("fetchPresence err", e); return []; }
}

async function savePresence() {
  try {
    await fetch(`${SUPABASE_URL}/rest/v1/presence`, {
      method: "POST",
      headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" },
      body: JSON.stringify({ user: username, online: true, name_color: nameColor, avatar_color: avatarColor, lastseen: new Date().toISOString() })
    });
  } catch(e){ console.error("presence insertErr", e); }
}

// Messages
async function loadMessages() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/messages?select=*&order=created_at.asc&limit=200`, {
      headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}` }
    });
    const data = await res.json();
    messagesPanel.innerHTML = "";
    data.forEach(m => {
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `<span class="username" style="color:${m.name_color}">${m.user}</span>: <span class="text">${m.text}</span>`;
      messagesPanel.appendChild(div);
    });
    messagesPanel.scrollTop = messagesPanel.scrollHeight;
  } catch(e){ console.error("loadMessages err", e); }
}

async function sendMessage() {
  let text = cleanText(messageInput.value);
  if(!text.trim()) return;
  messageInput.value = "";
  try {
    await fetch(`${SUPABASE_URL}/rest/v1/messages`, {
      method: "POST",
      headers: { "apikey": SUPABASE_KEY, "Authorization": `Bearer ${SUPABASE_KEY}`, "Content-Type": "application/json" },
      body: JSON.stringify({ user: username, text, name_color: nameColor, avatar_color: avatarColor, created_at: new Date().toISOString() })
    });
    loadMessages();
  } catch(e){ console.error("sendMessage err", e); }
}

// Load users
async function loadUsers() {
  const data = await fetchPresence();
  usersPanel.innerHTML = "";
  data.forEach(u => {
    const div = document.createElement("div");
    div.className = `user ${u.online ? "online" : ""}`;
    div.innerHTML = `<div class="avatar" style="background:${u.avatar_color}"></div><span style="color:${u.name_color}">${u.user}</span>`;
    usersPanel.appendChild(div);
  });
}

// Online updater
setInterval(() => { savePresence(); loadUsers(); loadMessages(); }, 5000);

// Init
savePresence();
loadUsers();
loadMessages();
</script>
</body>
</html>
