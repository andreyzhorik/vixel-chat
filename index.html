<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vixel Chat</title>
<style>
:root{
--bg:#000000;
--panel:#150000;
--panel2:#1b0000;
--accent1:#5A0000;
--accent2:#C00000;
--accent3:#FF2A2A;
--text:#ffffff;
--muted:#bbbbbb;
--avatar-size:36px;
--badword-bg:#FF2A2A;
}
html,body{height:100%;margin:0;overflow:hidden;background:linear-gradient(180deg,var(--bg),#1b0000);font-family:Inter,system-ui,Arial;color:var(--text);}
.wrap{height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;box-sizing:border-box;}
.app{width:100%;max-width:1100px;height:80vh;display:grid;grid-template-columns:3fr 1fr;gap:18px;min-height:0;}
.card{background:linear-gradient(180deg,var(--panel),var(--panel2));border-radius:14px;padding:12px;box-shadow:0 8px 30px rgba(0,0,0,0.7);display:flex;flex-direction:column;border:1px solid rgba(255,0,0,0.04);min-height:0;}
.messages{flex:1;overflow-y:auto;padding:12px;border-radius:8px;background:rgba(0,0,0,0.20);display:flex;flex-direction:column;gap:8px;min-height:0;scroll-behavior:smooth;}
.msgRow{display:flex;gap:10px;align-items:flex-start;max-width:100%;}
.avatar{width:var(--avatar-size);height:var(--avatar-size);min-width:var(--avatar-size);border-radius:50%;display:inline-grid;place-items:center;font-weight:700;border:1px solid rgba(255,255,255,0.06);text-transform:uppercase;flex-shrink:0;color:white;}
.msg{padding:10px 12px;border-radius:12px;background:rgba(255,255,255,0.04);font-size:15px;line-height:1.35;animation:pop .12s ease;max-width:90%;word-break:break-word;}
.meta{font-size:12px;color:var(--muted);margin-bottom:6px;}
@keyframes pop{from{opacity:0;transform:translateY(6px) scale(.99);}to{opacity:1;}}
.inputRow{display:flex;gap:8px;padding-top:10px;}
input[type="text"],input[type="color"]{background:transparent;border:1px solid rgba(255,255,255,0.12);color:var(--text);padding:10px;border-radius:8px;outline:none;flex:1;}
.btn{background:linear-gradient(90deg,var(--accent2),var(--accent3));padding:10px 14px;border-radius:8px;border:none;color:white;cursor:pointer;font-weight:700;}
.users{display:flex;flex-direction:column;gap:8px;}
.userCard{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);}
.statusDot{width:10px;height:10px;border-radius:50%;margin-left:auto;box-shadow:0 1px 4px rgba(0,0,0,0.6);}
.status-online{ background: #FF2A2A; }
.status-offline{ background: #555; }
.usersHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;color:var(--muted);}
.small{font-size:13px;color:var(--muted);}
.colorRow{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;}
.colorBtn{width:28px;height:28px;border-radius:50%;cursor:pointer;border:1px solid rgba(255,255,255,0.2);}
.moreBtn{padding:4px 8px;font-size:12px;background:linear-gradient(90deg,#FF2A2A,#950101);border:none;color:white;border-radius:4px;cursor:pointer;}
</style>
</head>
<body>
<div class="wrap">
<div class="app">

<!-- CHAT -->
<div class="card">
<div class="header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
<div class="title" style="font-weight:800;font-size:18px">Vixel Chat</div>
<div class="small" id="statusHint">not logged</div>
</div>

<div id="messages" class="messages" aria-live="polite"></div>

<div class="inputRow" style="margin-top:8px;">
<textarea id="messageInput" placeholder="Type a message..." style="flex:1;resize:none;height:40px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text)"></textarea>
<button id="sendBtn" class="btn">Send</button>
</div>

<div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
<input id="nameInput" placeholder="your name" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text)" />
<button id="loginBtn" class="btn">Set Name</button>
</div>

<div style="margin-top:6px;">
<div>Name Color:</div>
<div class="colorRow" id="nameColorRow"></div>
<div>Avatar Color:</div>
<div class="colorRow" id="avatarColorRow"></div>
<button class="moreBtn" id="moreColorsBtn">More</button>
<input type="color" id="customColorPicker" style="display:none"/>
</div>

</div>

<!-- USERS -->
<div class="card users">
<div class="usersHeader">
<div style="font-weight:800">Players</div>
<div class="small" id="onlineCount">0 online</div>
</div>
<div id="usersList" style="overflow:auto;flex:1;padding-right:6px"></div>
</div>

</div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = "https://ehciyxvbasqiiiurjuwu.supabase.co";
const supabaseKey = "YOUR_ANON_KEY"; 
const supabase = createClient(supabaseUrl,supabaseKey);

const messagesEl = document.getElementById("messages");
const msgInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");
const nameInput = document.getElementById("nameInput");
const loginBtn = document.getElementById("loginBtn");
const usersList = document.getElementById("usersList");
const onlineCountEl = document.getElementById("onlineCount");
const statusHint = document.getElementById("statusHint");
const nameColorRow = document.getElementById("nameColorRow");
const avatarColorRow = document.getElementById("avatarColorRow");
const moreColorsBtn = document.getElementById("moreColorsBtn");
const customColorPicker = document.getElementById("customColorPicker");

let username = localStorage.getItem("vixel_user")||"";
let presenceId = localStorage.getItem("vixel_presence_id")||null;
let messagesChannel = null;
let presenceChannel = null;
let onlineUsers={};
let nameColor = "#FF2A2A";
let avatarColor = "#FF2A2A";

const badwords=["badword1","badword2","xxx","shit","fuck"];
function filterBadWords(str){return badwords.reduce((s,w)=>s.replace(new RegExp(w,"gi"),"*".repeat(w.length)),str);}

const presetColors=["#FF2A2A","#950101","#3D0000","#000000"];

function avatarEl(name){
const letter=(name||"?").charAt(0).toUpperCase();
const el=document.createElement("div");
el.className="avatar";
el.style.background=avatarColor||"#FF2A2A";
el.textContent=letter;
return el;
}

function addMessageToDOM(msg){
const row=document.createElement("div");
row.className="msgRow";
row.appendChild(avatarEl(msg.user));
const box=document.createElement("div");
box.className="msg";
const meta=document.createElement("div");
meta.className="meta";
const time=msg.created_at?new Date(msg.created_at).toLocaleTimeString():"";
meta.innerHTML=`<strong style="color:${nameColor||"#FF2A2A"}">${escapeHtml(msg.user||"anon")}</strong> Â· <span class="small">${time}</span>`;
const text=document.createElement("div");
text.innerHTML=escapeHtml(filterBadWords(msg.text||""));
box.appendChild(meta);
box.appendChild(text);
row.appendChild(box);
messagesEl.appendChild(row);
messagesEl.scrollTop=messagesEl.scrollHeight;
}

function escapeHtml(str){return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));}

async function loadMessages(){try{const {data,error}=await supabase.from("messages").select("id,user,text,created_at").order("created_at",{ascending:true}).limit(200);if(error)throw error;messagesEl.innerHTML="";data?.forEach(addMessageToDOM);}catch(err){console.error("loadMessages err",err);}}

async function loadPresence(){try{const {data,error}=await supabase.from("presence").select("id,username,online");if(error)throw error;onlineUsers={};data?.forEach(row=>{onlineUsers[row.username]={username:row.username,online:row.online,id:row.id};});renderUsers();}catch(err){console.error("loadPresence err",err);}}

function renderUsers(){
usersList.innerHTML="";
const arr=Object.values(onlineUsers).sort((a,b)=>a.online===b.online?a.username.localeCompare(b.username):a.online?-1:1);
arr.forEach(u=>{const card=document.createElement("div");card.className="userCard";const av=document.createElement("div");av.className="avatar";av.style.background=avatarColor||"#FF2A2A";av.textContent=u.username.charAt(0).toUpperCase();av.style.width="30px";av.style.height="30px";av.style.minWidth="30px";card.appendChild(av);const nameEl=document.createElement("div");nameEl.style.fontWeight=700;nameEl.style.color=nameColor||"#FF2A2A";nameEl.textContent=u.username;card.appendChild(nameEl);const dot=document.createElement("div");dot.className="statusDot "+(u.online?"status-online":"status-offline");card.appendChild(dot);usersList.appendChild(card);});
const onlineCount=arr.filter(u=>u.online).length;onlineCountEl.textContent=`${onlineCount} online`;
}

async function sendMessage(){
const text=msgInput.value.trim();
if(!username)return alert("set a name first");
if(!text)return;
sendBtn.disabled=true;
try{const {data,error}=await supabase.from("messages").insert([{user:username,text}]).select("id,user,text,created_at");if(error)throw error;const inserted=(data&&data[0])||{user:username,text,created_at:new Date().toISOString()};addMessageToDOM(inserted);msgInput.value="";}catch(err){console.error("sendMessage err",err);alert("Failed to send message");}finally{sendBtn.disabled=false;msgInput.focus();}
}

async function ensurePresenceRow(){
if(!username)return;
try{
const {data,error}=await supabase.from("presence").upsert({username,online:true,name_color:nameColor,avatar_color:avatarColor}).select("id");if(error)throw error;if(data&&data[0]&&data[0].id){presenceId=data[0].id;localStorage.setItem("vixel_presence_id",presenceId);}
}catch(e){console.error("presence insertErr",e);}
}

function subscribeRealtime(){
if(messagesChannel||presenceChannel)return;
messagesChannel=supabase.channel("realtime:messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},payload=>{addMessageToDOM(payload.new);}).subscribe();
presenceChannel=supabase.channel("realtime:presence")
.on("postgres_changes",{event:"INSERT",schema:"public",table:"presence"},payload=>{const row=payload.new;onlineUsers[row.username]={username:row.username,online:row.online,id:row.id};renderUsers();})
.on("postgres_changes",{event:"UPDATE",schema:"public",table:"presence"},payload=>{const row=payload.new;onlineUsers[row.username]={username:row.username,online:row.online,id:row.id};renderUsers();})
.subscribe();
}

loginBtn.onclick=async()=>{
const name=nameInput.value.trim();if(!name)return;
const lastChange=localStorage.getItem("vixel_name_change")||0;
const now=Date.now();
if(now-lastChange<604800000){alert("You can change name once a week");return;}
username=name;
localStorage.setItem("vixel_user",username);
localStorage.setItem("vixel_name_change",now);
statusHint.textContent=`logged as ${username}`;
await ensurePresenceRow();
subscribeRealtime();
await loadPresence();
await loadMessages();
};

sendBtn.onclick=sendMessage;
msgInput.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}});

window.addEventListener("beforeunload",async()=>{if(username){try{await supabase.from("presence").update({online:false}).eq("username",username);}catch(err){};}});

moreColorsBtn.onclick=()=>{customColorPicker.click();};
customColorPicker.addEventListener("input",()=>{avatarColor=customColorPicker.value;nameColor=customColorPicker.value;ensurePresenceRow();renderUsers();});

function initColorButtons(row,prop){presetColors.forEach(c=>{const b=document.createElement("div");b.className="colorBtn";b.style.background=c;b.onclick=()=>{if(prop==="name")nameColor=c;else avatarColor=c;ensurePresenceRow();renderUsers();};row.appendChild(b);});}

initColorButtons(nameColorRow,"name");
initColorButtons(avatarColorRow,"avatar");

(async function init(){
if(username){
statusHint.textContent=`logged as ${username}`;
await ensurePresenceRow();
subscribeRealtime();
}
await loadPresence();
await loadMessages();
})();
</script>
</body>
</html>
