<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vixel Chat 2.0</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ================================
   ROOT VARIABLES & BASIC STYLES
================================ */
:root{
  --bg:#0f0f0f;
  --panel:#1c1c1c;
  --accent:#e63946;
  --text:#f5f5f5;
  --secondary:#2c2c2c;
  --hover:#333;
  --scrollbar:#444;
  --online:#43d9ad;
  --offline:#777;
  --transition:0.2s;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Orbitron',sans-serif;}
body{background:var(--bg);color:var(--text);display:flex;justify-content:center;align-items:center;height:100vh;}

/* ================================
   CHAT CONTAINER
================================ */
#chat-container{
  width:1000px;
  height:700px;
  display:grid;
  grid-template-columns:3fr 1fr;
  grid-template-rows:auto 1fr auto;
  gap:10px;
  padding:15px;
  background:var(--panel);
  border-radius:15px;
  box-shadow:0 0 15px rgba(0,0,0,0.5);
  position:relative;
}

/* ================================
   HEADER
================================ */
#header{
  grid-column:1/3;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#header img{
  height:60px;
}
#header button{
  padding:8px 18px;
  border-radius:8px;
  cursor:pointer;
  background:var(--accent);
  border:none;
  color:#fff;
  transition:var(--transition);
}
#header button:hover{
  background:#d62839;
}

/* ================================
   MESSAGES PANEL
================================ */
#messages-panel{
  grid-column:1/2;
  grid-row:2;
  background:var(--secondary);
  border-radius:10px;
  padding:15px;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
}
.message{
  display:flex;
  flex-direction:column;
  gap:4px;
  padding:8px 12px;
  border-radius:8px;
  background:var(--panel);
  transition:var(--transition);
}
.message:hover{background:var(--hover);}
.message-header{display:flex;justify-content:space-between;align-items:center;}
.message .username{font-weight:500;}
.message .text{white-space:pre-wrap;}
.message .timestamp{font-size:0.7em;color:#aaa;}

/* ================================
   USERS PANEL
================================ */
#users-panel{
  grid-column:2/3;
  grid-row:2;
  background:var(--secondary);
  border-radius:10px;
  padding:15px;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
}
.user{
  display:flex;
  align-items:center;
  gap:10px;
  padding:5px 10px;
  border-radius:6px;
  background:var(--panel);
  cursor:pointer;
  transition:var(--transition);
}
.user:hover{background:var(--hover);}
.user .avatar{
  width:30px;
  height:30px;
  border-radius:50%;
  background:red;
}
.user.online .avatar{border:2px solid var(--online);}
.user.offline .avatar{border:2px solid var(--offline);}
.user .name{flex:1; font-weight:500;}

/* ================================
   INPUT AREA
================================ */
#input-area{
  grid-column:1/3;
  display:flex;
  gap:10px;
}
#message-input{
  flex:1;
  padding:10px;
  border-radius:8px;
  border:none;
  background:var(--secondary);
  color:var(--text);
  resize:none;
}
#input-area button{
  border-radius:8px;
}

/* ================================
   COLOR PICKER MODAL
================================ */
#color-picker{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:var(--secondary);
  padding:20px;
  border-radius:15px;
  display:none;
  flex-direction:column;
  gap:15px;
  box-shadow:0 0 20px rgba(0,0,0,0.5);
}
#color-picker label{font-size:0.9em;}
#color-picker input[type=color]{width:100%;height:35px;border:none;border-radius:6px;cursor:pointer;}
#color-picker button{align-self:flex-end;}
#color-picker select{padding:6px;border-radius:6px;border:none;cursor:pointer;width:100%;}

/* ================================
   SCROLLBARS
================================ */
#messages-panel::-webkit-scrollbar,
#users-panel::-webkit-scrollbar{
  width:8px;
}
#messages-panel::-webkit-scrollbar-thumb,
#users-panel::-webkit-scrollbar-thumb{
  background:var(--scrollbar);
  border-radius:4px;
}

/* ================================
   TYPING INDICATOR
================================ */
#typing-indicator{
  position:absolute;
  bottom:75px;
  left:30px;
  font-size:0.85em;
  color:#aaa;
}

/* ================================
   ANIMATIONS
================================ */
@keyframes fadeInUp{
  from{opacity:0;transform:translateY(10px);}
  to{opacity:1;transform:translateY(0);}
}
.message{animation:fadeInUp 0.3s ease;}
</style>
</head>
<body>

<div id="chat-container">
  <div id="header">
    <img src="https://raw.githubusercontent.com/andreyzhorik/VIXEL/main/logonobg.png" alt="Logo">
    <button id="color-btn">Colors & Theme</button>
  </div>

  <div id="messages-panel"></div>
  <div id="users-panel"></div>

  <div id="input-area">
    <textarea id="message-input" rows="2" placeholder="Shift+Enter = new line"></textarea>
    <button id="send-btn">Send</button>
  </div>

  <div id="typing-indicator"></div>
</div>

<div id="color-picker">
  <label>Name Color:</label>
  <input type="color" id="name-color" value="#e63946">
  <label>Avatar Color:</label>
  <input type="color" id="avatar-color" value="#e63946">
  <label>Theme:</label>
  <select id="theme-selector">
    <option value="dark">Dark</option>
    <option value="gray">Gray</option>
    <option value="blue">Blue</option>
  </select>
  <button id="save-colors">Save</button>
</div>

<script>
// =====================================
// BASIC SETUP & LOCALSTORAGE
// =====================================
let username = localStorage.getItem("vixel-username");
if(!username){
  username = prompt("Enter your username:")||"Guest";
  localStorage.setItem("vixel-username", username);
}

let nameColor = "#e63946";
let avatarColor = "#e63946";

// DOM
const messagesPanel = document.getElementById("messages-panel");
const usersPanel = document.getElementById("users-panel");
const messageInput = document.getElementById("message-input");
const sendBtn = document.getElementById("send-btn");
const colorBtn = document.getElementById("color-btn");
const colorPicker = document.getElementById("color-picker");
const saveColorsBtn = document.getElementById("save-colors");
const nameInput = document.getElementById("name-color");
const avatarInput = document.getElementById("avatar-color");
const themeSelector = document.getElementById("theme-selector");
const typingIndicator = document.getElementById("typing-indicator");

// Badwords filter
const badWords = ["badword1","badword2"];
function cleanText(text){badWords.forEach(bw=>text=text.replaceAll(bw,"***"));return text;}

// =====================================
// COLOR PICKER EVENTS
// =====================================
colorBtn.onclick = ()=>{colorPicker.style.display="flex";}
saveColorsBtn.onclick = ()=>{
  nameColor = nameInput.value;
  avatarColor = avatarInput.value;
  applyTheme(themeSelector.value);
  colorPicker.style.display="none";
  savePresence();
}

// =====================================
// THEME SWITCHING
// =====================================
function applyTheme(theme){
  switch(theme){
    case"dark":
      document.documentElement.style.setProperty("--panel","#1c1c1c");
      document.documentElement.style.setProperty("--secondary","#2c2c2c");
      document.documentElement.style.setProperty("--accent","#e63946");
      break;
    case"gray":
      document.documentElement.style.setProperty("--panel","#2a2a2a");
      document.documentElement.style.setProperty("--secondary","#3a3a3a");
      document.documentElement.style.setProperty("--accent","#aaaaaa");
      break;
    case"blue":
      document.documentElement.style.setProperty("--panel","#1a1f2b");
      document.documentElement.style.setProperty("--secondary","#273347");
      document.documentElement.style.setProperty("--accent","#4ea8de");
      break;
  }
}

// =====================================
// SUPABASE CONFIG
// =====================================
const SUPABASE_URL = "https://ehciyxvbasqiiiurjuwu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVoY2l5eHZiYXNxaWlpdXJqdXd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzQzNTgsImV4cCI6MjA3OTY1MDM1OH0.yMZ8EqtPXJumjn2xHTXwG3jbWTNdDxrklYIkdXNcbQk";

// =====================================
// FETCH & SAVE PRESENCE
// =====================================
async function fetchPresence(){
  try{
    const res = await fetch(`${SUPABASE_URL}/rest/v1/presence?select=*`,{
      headers: {"apikey":SUPABASE_KEY,"Authorization":`Bearer ${SUPABASE_KEY}`}
    });
    return await res.json();
  }catch(e){console.error(e);return[];}
}

async function savePresence(){
  try{
    await fetch(`${SUPABASE_URL}/rest/v1/presence`,{
      method:"POST",
      headers:{
        "apikey":SUPABASE_KEY,
        "Authorization":`Bearer ${SUPABASE_KEY}`,
        "Content-Type":"application/json",
        "Prefer":"resolution=merge-duplicates"
      },
      body:JSON.stringify({username,online:true,name_color:nameColor,avatar_color:avatarColor,lastseen:new Date().toISOString()})
    });
  }catch(e){console.error(e);}
}

// =====================================
// LOAD USERS
// =====================================
async function loadUsers(){
  const data = await fetchPresence();
  const seen = new Set();
  usersPanel.innerHTML="";
  data.forEach(u=>{
    if(seen.has(u.username)) return;
    seen.add(u.username);
    const div = document.createElement("div");
    div.className = `user ${u.online?"online":"offline"}`;
    div.innerHTML=`<div class="avatar" style="background:${u.avatar_color}"></div><span class="name" style="color:${u.name_color}">${u.username}</span>`;
    usersPanel.appendChild(div);
  });
}

// =====================================
// MESSAGES
// =====================================
async function loadMessages(){
  try{
    const res = await fetch(`${SUPABASE_URL}/rest/v1/messages?select=*&order=created_at.asc&limit=200`,{
      headers: {"apikey":SUPABASE_KEY,"Authorization":`Bearer ${SUPABASE_KEY}`}
    });
    const data = await res.json();
    messagesPanel.innerHTML="";
    data.forEach(m=>{
      const div = document.createElement("div");
      div.className="message";
      const timestamp = new Date(m.created_at).toLocaleTimeString();
      div.innerHTML=`<div class="message-header"><span class="username" style="color:${m.name_color}">${m.user}</span><span class="timestamp">${timestamp}</span></div>
                     <div class="text">${m.text}</div>`;
      messagesPanel.appendChild(div);
    });
    messagesPanel.scrollTop = messagesPanel.scrollHeight;
  }catch(e){console.error(e);}
}

// =====================================
// SEND MESSAGE
// =====================================
async function sendMessage(){
  let text = cleanText(messageInput.value);
  if(!text.trim()) return;
  messageInput.value="";
  try{
    await fetch(`${SUPABASE_URL}/rest/v1/messages`,{
      method:"POST",
      headers: {"apikey":SUPABASE_KEY,"Authorization":`Bearer ${SUPABASE_KEY}`,"Content-Type":"application/json"},
      body: JSON.stringify({user:username,text,name_color:nameColor,avatar_color:avatarColor,created_at:new Date().toISOString()})
    });
    loadMessages();
  }catch(e){console.error(e);}
}

// =====================================
// INPUT EVENTS
// =====================================
sendBtn.onclick=sendMessage;
messageInput.onkeydown = e=>{
  if(e.shiftKey && e.key==="Enter") return;
  if(e.key==="Enter"){ e.preventDefault(); sendMessage();}
}

// =====================================
// TYPING INDICATOR
// =====================================
let typingTimeout;
messageInput.addEventListener("input",()=>{
  typingIndicator.textContent = `${username} is typing...`;
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{typingIndicator.textContent="";},1000);
});

// =====================================
// AUTO REFRESH
// =====================================
setInterval(()=>{savePresence();loadUsers();loadMessages();},5000);

// =====================================
// INIT
// =====================================
savePresence();
loadUsers();
loadMessages();
</script>
</body>
</html>
