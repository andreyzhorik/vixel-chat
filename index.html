<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vixel Chat</title>

<style>
  :root{
    --bg:#000000;
    --panel:#150000;
    --accent1:#5A0000;
    --accent2:#C00000;
    --accent3:#FF2A2A;
    --text:#ffffff;
    --muted:#bbbbbb;
  }

  /* Prevent whole page from scrolling */
  html, body{
    height:100%;
    margin:0;
    overflow:hidden;
    background:linear-gradient(180deg,var(--bg),#1b0000);
    font-family:Inter,system-ui;
    color:var(--text);
  }

  body{
    display:flex;
    align-items:center;
    justify-content:center;
    padding:18px;
  }

  /* App grid */
  .app{
    width:100%;
    max-width:1100px;
    height:80vh;
    display:grid;
    grid-template-columns:3fr 1fr;
    gap:18px;
  }

  .card{
    background:linear-gradient(180deg,var(--panel),#220000);
    border-radius:14px;
    padding:12px;
    box-shadow:0 8px 30px rgba(0,0,0,0.7);
    display:flex;
    flex-direction:column;
  }

  /* logo image */
  .logo{
    width:52px;
    height:52px;
    border-radius:10px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
    animation:glow 3s infinite ease-in-out;
  }

  .logo img{
    width:100%;
    height:100%;
    object-fit:contain;
  }

  @keyframes glow{
    0%{ box-shadow:0 0 8px var(--accent3); }
    50%{ box-shadow:0 0 18px var(--accent3); }
    100%{ box-shadow:0 0 8px var(--accent3); }
  }

  .title{font-size:20px;}

  /* ONLY chat scrolls */
  .chat{
    flex:1;
    overflow-y:auto;
    overflow-x:hidden;
    padding:8px;
    border-radius:8px;
    background:rgba(0,0,0,0.25);
  }

  /* messages */
  .msg{
    margin:6px 0;
    padding:8px;
    border-radius:8px;
    background:rgba(255,255,255,0.05);
    max-width:84%;
    display:flex;
    gap:8px;
    align-items:center;
    animation:pop .15s ease-out;
  }

  @keyframes pop{
    from{transform:scale(.96);opacity:0;}
    to{transform:scale(1);opacity:1;}
  }

  .avatar{
    width:26px;
    height:26px;
    border-radius:6px;
    background:var(--accent3);
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:bold;
    color:white;
    flex-shrink:0;
  }

  .msg .who{
    font-weight:700;
    color:var(--accent3);
  }

  .inputRow{
    display:flex;
    gap:8px;
    padding-top:10px;
  }

  input{
    background:transparent;
    border:1px solid rgba(255,255,255,0.15);
    color:var(--text);
    padding:8px;
    border-radius:8px;
    outline:none;
  }

  .players{
    display:flex;
    flex-direction:column;
    gap:8px;
    height:100%;
  }

  .playerList{
    overflow:auto;
    flex:1;
    padding:6px;
    background:rgba(0,0,0,0.18);
    border-radius:8px;
  }

  .player{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px;
    border-radius:8px;
  }

  .player .avatar{
    background:var(--accent2);
  }

  .dot{
    width:10px;
    height:10px;
    border-radius:50%;
  }

  .online{background:var(--accent2);}
  .offline{background:#444;}

  .btn{
    background:linear-gradient(90deg,var(--accent2),var(--accent3));
    padding:8px 10px;
    border-radius:8px;
    border:none;
    color:white;
    cursor:pointer;
    transition:.2s;
  }

  .btn:hover{
    transform:scale(1.05);
  }

  /* Typing indicator */
  #typing{
    height:20px;
    padding-left:8px;
    color:var(--muted);
    font-size:13px;
    display:flex;
    align-items:center;
    gap:4px;
    opacity:0;
    transition:.2s;
  }

  .dotT{
    width:6px;
    height:6px;
    border-radius:50%;
    background:var(--muted);
    animation:bounce 1s infinite;
  }

  .dotT:nth-child(2){ animation-delay:.2s; }
  .dotT:nth-child(3){ animation-delay:.4s; }

  @keyframes bounce{
    0%,100%{transform:translateY(0);}
    50%{transform:translateY(-4px);}
  }
</style>
</head>

<body>
<div class="app">

  <!-- CHAT PANEL -->
  <div class="card">

    <div class="header" style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
      <div class="logo">
        <img src="https://raw.githubusercontent.com/andreyzhorik/VIXEL/main/logonobg.png">
      </div>
      <div>
        <div class="title">Vixel Chat</div>
        <div style="color:var(--muted)">cleaner ui + red glow</div>
      </div>
      <div style="margin-left:auto;color:var(--muted)" id="statusBadge">not connected</div>
    </div>

    <div id="chat" class="chat"></div>

    <!-- typing indicator -->
    <div id="typing">
      <div class="dotT"></div>
      <div class="dotT"></div>
      <div class="dotT"></div>
    </div>

    <div class="inputRow">
      <input id="messageInput" type="text" placeholder="Type a message..." />
      <button id="sendBtn" class="btn">send</button>
    </div>

    <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
      <input id="nameInput" placeholder="your name" style="flex:1" />
      <button id="loginBtn" class="btn">set name</button>
    </div>
  </div>

  <!-- PLAYERS PANEL -->
  <div class="card players">
    <div style="display:flex;justify-content:space-between;">
      <strong>Players</strong>
      <div id="onlineCount" style="color:var(--muted)">0 online</div>
    </div>
    <div id="playerList" class="playerList"></div>
  </div>

</div>

<script>
const WORKER_URL = "https://vixel-chat.mrviktor2426.workers.dev";

let token = localStorage.getItem('vixel_token');
let username = localStorage.getItem('vixel_user');
let lastMsgId = 0;

const POLL = 2000;
const PRESENCE = 8000;

/* name change cooldown */
const NAME_LIMIT = 7 * 24 * 60 * 60 * 1000;

const chatEl = document.getElementById("chat");
const playerListEl = document.getElementById("playerList");
const statusBadge = document.getElementById("statusBadge");
const msgInput = document.getElementById("messageInput");
const nameInput = document.getElementById("nameInput");
const typingEl = document.getElementById("typing");

/* escape */
function escapeHtml(t){
  return t.replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));
}

function setStatus(t){
  statusBadge.textContent = t;
}

async function API(path, method="GET", body=null){
  const h = {"Accept":"application/json"};
  if(token) h["Authorization"] = "Bearer "+token;
  if(body) h["Content-Type"] = "application/json";

  const res = await fetch(WORKER_URL + path,{
    method,
    headers:h,
    body:body ? JSON.stringify(body) : null
  });

  if(!res.ok) throw new Error(await res.text());
  return res.json();
}

/* NAME SET WITH COOLDOWN */
async function setName(){
  const name = nameInput.value.trim();
  if(!name) return alert("enter a name bro");

  const last = localStorage.getItem("vixel_last_name_change");
  if(last && (Date.now() - Number(last)) < NAME_LIMIT){
    const daysLeft = Math.ceil((NAME_LIMIT - (Date.now()-last)) / (1000*60*60*24));
    return alert("you can change your name again in "+daysLeft+" day(s)");
  }

  try{
    const r = await API("/register","POST",{name});
    token = r.token;
    username = name;

    localStorage.setItem("vixel_token",token);
    localStorage.setItem("vixel_user",name);
    localStorage.setItem("vixel_last_name_change", Date.now());

    setStatus("connected as "+name);
    nameInput.value = "";
  }catch(e){
    alert("name issue: "+e.message);
  }
}

async function sendMessage(){
  const t = msgInput.value.trim();
  if(!t) return;

  try{
    await API("/send","POST",{text:t});
    msgInput.value = "";
    typingEl.style.opacity = 0;
    fetchMessages();
  }catch(e){
    alert("send fail: "+e.message);
  }
}

async function fetchMessages(){
  try{
    const r = await API("/messages?after="+lastMsgId);
    if(r.messages?.length){
      lastMsgId = r.messages[r.messages.length-1].id;

      chatEl.innerHTML = r.all.map(m => `
        <div class="msg">
          <div class="avatar">${m.user[0].toUpperCase()}</div>
          <div>
            <div class="who">${escapeHtml(m.user)}</div>
            <div>${escapeHtml(m.text)}</div>
          </div>
        </div>
      `).join("");

      chatEl.scrollTop = chatEl.scrollHeight;
    }
  }catch(e){}
}

async function fetchPlayers(){
  try{
    const r = await API("/players");
    const now = Date.now();
    let onlineCount = 0;

    playerListEl.innerHTML = r.players.map(p=>{
      const isOnline = (now - p.lastSeen) < 20000;
      if(isOnline) onlineCount++;

      return `
        <div class="player">
          <div class="dot ${isOnline ? "online" : "offline"}"></div>
          <div class="avatar">${p.name[0].toUpperCase()}</div>
          <strong>${escapeHtml(p.name)}</strong>
        </div>
      `;
    }).join("");

    document.getElementById("onlineCount").textContent = onlineCount + " online";
  }catch(e){
    playerListEl.innerHTML = "<div style='color:red;'>Failed to load players</div>";
  }
}

async function heartbeat(){
  try{ await API("/presence","POST"); }catch(e){}
}

/* typing indicator */
msgInput.addEventListener("input", () => {
  typingEl.style.opacity = msgInput.value.trim() ? 1 : 0;
});

document.getElementById("loginBtn").onclick = setName;
document.getElementById("sendBtn").onclick = sendMessage;
msgInput.addEventListener("keydown",e=>{
  if(e.key==="Enter") sendMessage();
});

setInterval(fetchMessages,POLL);
setInterval(()=>{heartbeat();fetchPlayers();},PRESENCE);

(async ()=>{
  if(token && username){
    setStatus("connected as "+username);
    await heartbeat();
    fetchMessages();
    fetchPlayers();
  }
})();
</script>
</body>
</html>
