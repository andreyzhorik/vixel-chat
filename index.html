<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vixel Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  margin: 0;
  font-family: Inter, system-ui;
  background: #0b0b0b;
  color: white;
  display: flex;
  height: 100vh;
}

#users {
  width: 240px;
  background: #111;
  border-right: 1px solid #222;
  padding: 10px;
  overflow-y: auto;
}

#chat {
  flex: 1;
  display: flex;
  flex-direction: column;
}

#messages {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}

.msg {
  margin-bottom: 8px;
}

.input {
  display: flex;
  border-top: 1px solid #222;
}

input {
  flex: 1;
  padding: 12px;
  background: #111;
  color: white;
  border: none;
  outline: none;
}

button {
  background: #ff2b2b;
  border: none;
  color: white;
  padding: 12px 16px;
  cursor: pointer;
}
</style>
</head>

<body>

<div id="users"></div>

<div id="chat">
  <div id="messages"></div>
  <div class="input">
    <input id="msg" placeholder="type..." />
    <button onclick="send()">Send</button>
  </div>
</div>

<script>
const API = "https://ehciyxvbasqiiiurjuwu.supabase.co/functions/v1/super-endpoint";

let username = localStorage.getItem("username");
if (!username) {
  username = prompt("username?");
  localStorage.setItem("username", username);
}

const avatar_color = "#180101";
const name_color = "#ff2b2b";

async function call(data) {
  const res = await fetch(API, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  return res.json();
}

// ---- USERS ----
async function ping() {
  await call({
    action: "ping_user",
    username,
    avatar_color,
    name_color
  });
}

async function loadUsers() {
  const users = await call({ action: "get_users" });
  const box = document.getElementById("users");
  box.innerHTML = "<b>Players</b><br><br>";
  users.forEach(u => {
    box.innerHTML += `
      <div style="color:${u.name_color}">
        ‚óè ${u.username} ${u.online ? "" : "(off)"}
      </div>`;
  });
}

// ---- MESSAGES ----
async function loadMessages() {
  const msgs = await call({ action: "get_messages" });
  const box = document.getElementById("messages");
  box.innerHTML = "";
  msgs.forEach(m => {
    box.innerHTML += `
      <div class="msg">
        <b style="color:${m.name_color}">${m.user}:</b>
        ${m.text}
      </div>`;
  });
  box.scrollTop = box.scrollHeight;
}

async function send() {
  const input = document.getElementById("msg");
  if (!input.value) return;

  await call({
    action: "send_message",
    username,
    text: input.value,
    avatar_color,
    name_color
  });

  input.value = "";
  loadMessages();
}

// ---- LOOP ----
ping();
loadUsers();
loadMessages();

setInterval(ping, 5000);
setInterval(loadUsers, 4000);
setInterval(loadMessages, 2000);
</script>

</body>
</html>
